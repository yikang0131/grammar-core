#!/bin/bash

# é…ç½®å‚æ•°
PUBLIC_HOST="8.8.8.8"      # å…¬ç½‘åœ°å€ï¼ˆGoogle DNSï¼‰
PRIVATE_HOST="192.168.1.1" # å†…ç½‘åœ°å€ï¼ˆé€šå¸¸æ˜¯ç½‘å…³ï¼‰ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
NETWORK_INTERFACE="eno1"    # ç½‘ç»œæ¥å£åç§°
LOG_FILE="/var/log/network-monitor.log"
PING_COUNT=3               # pingæ¬¡æ•°
PING_TIMEOUT=10            # pingè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
MAX_RETRIES=2              # å¤±è´¥é‡è¯•æ¬¡æ•°
RECONNECT_ATTEMPTS=3       # ç½‘ç»œé‡è¿å°è¯•æ¬¡æ•°

# åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
touch $LOG_FILE

# æ—¥å¿—å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# pingæ£€æµ‹å‡½æ•°
check_host() {
    local host=$1
    local host_type=$2
    
    ping -c $PING_COUNT -W $PING_TIMEOUT $host > /dev/null 2>&1
    local result=$?
    
    if [ $result -eq 0 ]; then
        log_message "âœ“ ${host_type}åœ°å€ $host å¯è¾¾"
        return 0
    else
        log_message "âœ— ${host_type}åœ°å€ $host ä¸å¯è¾¾"
        return 1
    fi
}

# æ£€æŸ¥ç½‘ç»œæ¥å£çŠ¶æ€
check_interface_status() {
    local interface=$1
    
    # æ£€æŸ¥æ¥å£æ˜¯å¦å­˜åœ¨
    if ! ip link show $interface > /dev/null 2>&1; then
        log_message "é”™è¯¯ï¼šç½‘ç»œæ¥å£ $interface ä¸å­˜åœ¨"
        return 1
    fi
    
    # æ£€æŸ¥æ¥å£çŠ¶æ€
    local status=$(ip link show $interface | grep -o "state [A-Z]*" | cut -d' ' -f2)
    log_message "ç½‘ç»œæ¥å£ $interface çŠ¶æ€: $status"
    
    if [ "$status" = "UP" ]; then
        return 0
    else
        return 1
    fi
}

# é‡æ–°è¿æ¥ç½‘ç»œæ¥å£
reconnect_network_interface() {
    local interface=$1
    local attempt=$2
    
    log_message "=== ç¬¬ $attempt æ¬¡å°è¯•é‡æ–°è¿æ¥ç½‘ç»œæ¥å£ $interface ==="
    
    # 1. ç¦ç”¨ç½‘ç»œæ¥å£
    log_message "ç¦ç”¨ç½‘ç»œæ¥å£ $interface..."
    if sudo ip link set $interface down; then
        log_message "âœ“ ç½‘ç»œæ¥å£å·²ç¦ç”¨"
    else
        log_message "âœ— ç¦ç”¨ç½‘ç»œæ¥å£å¤±è´¥"
        return 1
    fi
    
    sleep 5
    
    # 2. å¯ç”¨ç½‘ç»œæ¥å£
    log_message "å¯ç”¨ç½‘ç»œæ¥å£ $interface..."
    if sudo ip link set $interface up; then
        log_message "âœ“ ç½‘ç»œæ¥å£å·²å¯ç”¨"
    else
        log_message "âœ— å¯ç”¨ç½‘ç»œæ¥å£å¤±è´¥"
        return 1
    fi
    
    sleep 10
    
    # 3. é‡å¯NetworkManageræœåŠ¡
    log_message "é‡å¯NetworkManageræœåŠ¡..."
    if sudo systemctl restart NetworkManager; then
        log_message "âœ“ NetworkManagerå·²é‡å¯"
    else
        log_message "âœ— NetworkManageré‡å¯å¤±è´¥"
    fi
    
    sleep 15
    
    # 4. å°è¯•é‡æ–°è·å–IPåœ°å€ï¼ˆDHCPï¼‰
    log_message "å°è¯•é‡æ–°è·å–IPåœ°å€..."
    if sudo dhclient -r $interface > /dev/null 2>&1; then
        log_message "âœ“ é‡Šæ”¾æ—§IPåœ°å€"
    fi
    
    sleep 5
    
    if sudo dhclient $interface > /dev/null 2>&1; then
        log_message "âœ“ é‡æ–°è·å–IPåœ°å€"
    else
        log_message "âœ— é‡æ–°è·å–IPåœ°å€å¤±è´¥"
    fi
    
    sleep 10
    
    # 5. æ£€æŸ¥æ¥å£çŠ¶æ€å’ŒIPåœ°å€
    check_interface_status $interface
    local ip_addr=$(ip addr show $interface | grep "inet " | awk '{print $2}' | head -n1)
    if [ -n "$ip_addr" ]; then
        log_message "âœ“ ç½‘ç»œæ¥å£ $interface IPåœ°å€: $ip_addr"
        return 0
    else
        log_message "âœ— ç½‘ç»œæ¥å£ $interface æœªè·å–åˆ°IPåœ°å€"
        return 1
    fi
}

# ç½‘ç»œæ•…éšœæ¢å¤å°è¯•
attempt_network_recovery() {
    log_message "!!! æ£€æµ‹åˆ°ç½‘ç»œå¼‚å¸¸ï¼Œå¼€å§‹ç½‘ç»œæ¢å¤æµç¨‹ !!!"
    
    # é¦–å…ˆæ£€æŸ¥ç½‘ç»œæ¥å£çŠ¶æ€
    check_interface_status $NETWORK_INTERFACE
    
    # å°è¯•é‡æ–°è¿æ¥ç½‘ç»œ
    for i in $(seq 1 $RECONNECT_ATTEMPTS); do
        log_message "--- ç½‘ç»œæ¢å¤å°è¯• $i/$RECONNECT_ATTEMPTS ---"
        
        if reconnect_network_interface $NETWORK_INTERFACE $i; then
            log_message "âœ“ ç½‘ç»œæ¥å£é‡è¿æˆåŠŸï¼Œç­‰å¾…30ç§’åæµ‹è¯•è¿é€šæ€§..."
            sleep 30
            
            # æµ‹è¯•ç½‘ç»œè¿é€šæ€§
            log_message "æµ‹è¯•ç½‘ç»œæ¢å¤åçš„è¿é€šæ€§..."
            if check_network_connectivity; then
                log_message "ğŸ‰ ç½‘ç»œæ¢å¤æˆåŠŸï¼"
                return 0
            else
                log_message "âœ— ç½‘ç»œé‡è¿åä»æ— æ³•è¿é€š"
            fi
        else
            log_message "âœ— ç¬¬ $i æ¬¡ç½‘ç»œé‡è¿å¤±è´¥"
        fi
        
        if [ $i -lt $RECONNECT_ATTEMPTS ]; then
            log_message "ç­‰å¾…30ç§’åè¿›è¡Œä¸‹ä¸€æ¬¡å°è¯•..."
            sleep 30
        fi
    done
    
    log_message "!!! æ‰€æœ‰ç½‘ç»œæ¢å¤å°è¯•éƒ½å¤±è´¥äº† !!!"
    return 1
}

# ç®€å•çš„ç½‘ç»œè¿é€šæ€§æµ‹è¯•ï¼ˆç”¨äºæ¢å¤åéªŒè¯ï¼‰
check_network_connectivity() {
    local public_ok=false
    local private_ok=false
    
    if check_host $PUBLIC_HOST "å…¬ç½‘"; then
        public_ok=true
    fi
    
    if check_host $PRIVATE_HOST "å†…ç½‘"; then
        private_ok=true
    fi
    
    if [ "$public_ok" = true ] && [ "$private_ok" = true ]; then
        return 0
    else
        return 1
    fi
}

# ç½‘ç»œå…¨é¢æ£€æµ‹å‡½æ•°
check_network_full() {
    local public_ok=false
    local private_ok=false
    local retry_count=0
    
    # é‡è¯•æœºåˆ¶
    while [ $retry_count -lt $MAX_RETRIES ]; do
        log_message "å¼€å§‹ç¬¬ $((retry_count + 1)) æ¬¡ç½‘ç»œæ£€æµ‹"
        
        # æ£€æµ‹å…¬ç½‘è¿é€šæ€§
        if check_host $PUBLIC_HOST "å…¬ç½‘"; then
            public_ok=true
        fi
        
        # æ£€æµ‹å†…ç½‘è¿é€šæ€§
        if check_host $PRIVATE_HOST "å†…ç½‘"; then
            private_ok=true
        fi
        
        # å¦‚æœä¸¤ä¸ªåœ°å€éƒ½èƒ½pingé€šï¼Œç½‘ç»œæ­£å¸¸
        if [ "$public_ok" = true ] && [ "$private_ok" = true ]; then
            log_message "ç½‘ç»œçŠ¶æ€ï¼šæ­£å¸¸ï¼ˆå…¬ç½‘å’Œå†…ç½‘éƒ½å¯è¾¾ï¼‰"
            return 0
        fi
        
        # å¦‚æœåªæœ‰ä¸€ä¸ªèƒ½pingé€šï¼Œè®°å½•ä½†ç»§ç»­é‡è¯•
        if [ "$public_ok" = true ] && [ "$private_ok" = false ]; then
            log_message "ç½‘ç»œçŠ¶æ€ï¼šéƒ¨åˆ†å¼‚å¸¸ï¼ˆä»…å…¬ç½‘å¯è¾¾ï¼Œå†…ç½‘ä¸å¯è¾¾ï¼‰"
        elif [ "$public_ok" = false ] && [ "$private_ok" = true ]; then
            log_message "ç½‘ç»œçŠ¶æ€ï¼šéƒ¨åˆ†å¼‚å¸¸ï¼ˆä»…å†…ç½‘å¯è¾¾ï¼Œå…¬ç½‘ä¸å¯è¾¾ï¼‰"
        else
            log_message "ç½‘ç»œçŠ¶æ€ï¼šå®Œå…¨å¼‚å¸¸ï¼ˆå…¬ç½‘å’Œå†…ç½‘éƒ½ä¸å¯è¾¾ï¼‰"
        fi
        
        retry_count=$((retry_count + 1))
        
        if [ $retry_count -lt $MAX_RETRIES ]; then
            log_message "ç­‰å¾…10ç§’åè¿›è¡Œé‡è¯•..."
            sleep 10
        fi
        
        # é‡ç½®çŠ¶æ€ä¸ºä¸‹æ¬¡æ£€æµ‹
        public_ok=false
        private_ok=false
    done
    
    # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
    return 1
}

# ç½‘ç»œç›‘æ§ä¸»å¾ªç¯
monitor_network() {
    log_message "=== ç½‘ç»œç›‘æ§è„šæœ¬å¯åŠ¨ ==="
    log_message "ç›‘æ§é…ç½®ï¼š"
    log_message "  å…¬ç½‘åœ°å€: $PUBLIC_HOST"
    log_message "  å†…ç½‘åœ°å€: $PRIVATE_HOST"
    log_message "  ç½‘ç»œæ¥å£: $NETWORK_INTERFACE"
    log_message "  æ£€æµ‹é—´éš”: 30åˆ†é’Ÿ"
    log_message "  é‡è¯•æ¬¡æ•°: $MAX_RETRIES"
    log_message "  é‡è¿å°è¯•: $RECONNECT_ATTEMPTS"
    log_message "=========================="
    
    # æ£€æŸ¥ç½‘ç»œæ¥å£æ˜¯å¦å­˜åœ¨
    if ! check_interface_status $NETWORK_INTERFACE; then
        log_message "é”™è¯¯ï¼šç½‘ç»œæ¥å£ $NETWORK_INTERFACE çŠ¶æ€å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥é…ç½®"
        exit 1
    fi
    
    while true; do
        log_message "--- å¼€å§‹ç½‘ç»œè¿é€šæ€§æ£€æµ‹ ---"
        
        if check_network_full; then
            log_message "ç½‘ç»œæ£€æµ‹ç»“æœï¼šæ­£å¸¸"
        else
            log_message "!!! ç½‘ç»œæ£€æµ‹ç»“æœï¼šå¼‚å¸¸ !!!"
            
            # å°è¯•ç½‘ç»œæ¢å¤
            if attempt_network_recovery; then
                log_message "ğŸ‰ ç½‘ç»œæ¢å¤æˆåŠŸï¼Œç»§ç»­ç›‘æ§"
            else
                log_message "ğŸ’¥ ç½‘ç»œæ¢å¤å¤±è´¥ï¼Œå‡†å¤‡é‡å¯ç³»ç»Ÿ..."
                
                # è®°å½•é‡å¯åŸå› åˆ°ç³»ç»Ÿæ—¥å¿—
                logger "ç½‘ç»œç›‘æ§ï¼šç½‘ç»œæ¢å¤å¤±è´¥ï¼Œå…¬ç½‘($PUBLIC_HOST)æˆ–å†…ç½‘($PRIVATE_HOST)è¿æ¥å¼‚å¸¸ï¼Œç³»ç»Ÿå³å°†é‡å¯"
                
                # æœ€åä¸€æ¬¡è¯¦ç»†æ£€æµ‹å¹¶è®°å½•
                log_message "é‡å¯å‰æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ï¼š"
                check_host $PUBLIC_HOST "å…¬ç½‘"
                check_host $PRIVATE_HOST "å†…ç½‘"
                check_interface_status $NETWORK_INTERFACE
                
                log_message "ç³»ç»Ÿå°†åœ¨10ç§’åé‡å¯..."
                sleep 10
                /sbin/reboot
            fi
        fi
        
        log_message "ä¸‹æ¬¡æ£€æµ‹æ—¶é—´: $(date -d '+30 minutes' '+%Y-%m-%d %H:%M:%S')"
        log_message "--- ç½‘ç»œæ£€æµ‹å®Œæˆï¼Œç­‰å¾…30åˆ†é’Ÿ ---"
        
        # ç­‰å¾…30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰
        sleep 1800
    done
}

# ä¿¡å·å¤„ç†
cleanup() {
    log_message "æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œç½‘ç»œç›‘æ§è„šæœ¬é€€å‡º"
    exit 0
}

trap cleanup SIGTERM SIGINT

# æ£€æŸ¥é…ç½®
if [ -z "$PUBLIC_HOST" ] || [ -z "$PRIVATE_HOST" ] || [ -z "$NETWORK_INTERFACE" ]; then
    log_message "é”™è¯¯ï¼šPUBLIC_HOSTã€PRIVATE_HOST æˆ– NETWORK_INTERFACE æœªé…ç½®"
    exit 1
fi

# å¯åŠ¨ç›‘æ§
monitor_network